name: Multi-Platform Docker Build (x64 & arm64)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® QEMU (ç”¨äºè·¨å¹³å°æ„å»º)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      # 3. è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      # 4. ç™»å½•åˆ° GitHub Container Registry
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. æå–å…ƒæ•°æ® (æ ‡ç­¾ç­‰)
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      # 6. å‡†å¤‡ç¯å¢ƒæ–‡ä»¶ (æ¨¡æ‹Ÿæœ¬åœ°éƒ¨ç½²æ­¥éª¤)
      - name: Prepare environment files
        run: |
          # å¤åˆ¶ç¯å¢ƒæ¨¡æ¿
          if [ -f .env.template ]; then
            cp .env.template .env
            echo "Created .env from template"
          else
            echo "Warning: .env.template not found"
          fi
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶
          mkdir -p ./files
          touch ./files/allow-postgres14-upgrade
          echo "Created ./files/allow-postgres14-upgrade"
          
          # æ˜¾ç¤ºç›®å½•ç»“æ„
          ls -la
          ls -la ./files/ 2>/dev/null || echo "No files directory"

      # 7. å¤šå¹³å°æ„å»ºå¹¶æ¨é€é•œåƒ
      - name: Build and push Docker image (Multi-platform)
        uses: docker/bake-action@v4
        with:
          files: |
            ./docker-compose.yml
            ${{ steps.meta.outputs.bake-file }}
          targets: default
          push: true
          set: |
            *.platform=linux/amd64,linux/arm64
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max

      # 8. æ›¿ä»£æ–¹æ¡ˆï¼šå¦‚æœä¸Šé¢çš„ bake ä¸é€‚ç”¨ï¼Œä½¿ç”¨ docker-compose buildx æ„å»º
      # æ³¨æ„ï¼šè¿™ä¸€æ­¥ä»…æ„å»ºï¼Œä¸è¿è¡Œå®¹å™¨ï¼ˆCI ç¯å¢ƒé€šå¸¸ä¸éœ€è¦è¿è¡Œï¼‰
      - name: Build images with docker compose (Alternative)
        if: failure()  # å¦‚æœä¸Šä¸€æ­¥å¤±è´¥ï¼Œå°è¯•è¿™ä¸ª
        run: |
          docker compose build --no-cache

      # 9. éªŒè¯é•œåƒ (æŸ¥çœ‹æ„å»ºç»“æœ)
      - name: Inspect built images
        run: |
          echo "=== æ„å»ºçš„é•œåƒåˆ—è¡¨ ==="
          docker images | grep ${{ env.IMAGE_NAME }} || echo "ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´"
          docker images
          
          echo "=== éªŒè¯å¤šå¹³å°æ”¯æŒ ==="
          docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest || true

      # 10. å¯é€‰ï¼šåœ¨ CI ä¸­æµ‹è¯•éƒ¨ç½² (å¦‚æœéœ€è¦)
      - name: Test deployment (Optional)
        if: github.event_name == 'pull_request'  # ä»…åœ¨ PR æ—¶æµ‹è¯•
        run: |
          echo "Starting services for testing..."
          docker compose up -d --wait
          
          echo "Waiting for services to be healthy..."
          sleep 30
          
          echo "=== å®¹å™¨çŠ¶æ€ ==="
          docker compose ps
          
          echo "=== å®¹å™¨æ—¥å¿— ==="
          docker compose logs --tail=50
          
          # æ¸…ç†
          docker compose down

      # 11. è¾“å‡ºæ‘˜è¦
      - name: Build Summary
        run: |
          echo "âœ… å¤šå¹³å°æ„å»ºå®Œæˆ (linux/amd64, linux/arm64)"
          echo "ğŸ“¦ é•œåƒåœ°å€: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "ğŸ·ï¸  æ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
